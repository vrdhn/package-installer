// Code generated by cligen; DO NOT EDIT.

package {{.Pkg}}

import (
	"fmt"
)

type Action[T any] func() (T, error)

type FlagDef struct {
	Name  string
	Short string
	Type  string
	Desc  string
}

type ArgDef struct {
	Name string
	Type string
	Desc string
}

type CommandDef struct {
	Name        string
	FullCommand string
	Desc        string
{{- range .AttrDefs }}
	{{ goFieldName .Name }} {{ goTypeForAttr .Kind }}
{{- end }}
	Args     []ArgDef
	Flags    []FlagDef
	Subs     []CommandDef
	Examples []string
}

type TopicDef struct {
	Name string
	Desc string
	Text string
}

type GlobalFlags struct {
{{- range .GlobalFlags }}
	{{ goFieldName .Name }} {{ goTypeForFlag .Type }}
{{- end }}
{{- if eq (len .GlobalFlags) 0 }}
	_ struct{}
{{- end }}
}

{{- range .Leafs }}
{{- $base := goNameForPath (cmdPath .) }}

type {{ $base }}Params struct {
	GlobalFlags
{{- if .Args }}
{{- range .Args }}
	{{ goFieldName .Name }} {{ goTypeForArg .Type }}
{{- end }}
{{- end }}
{{- if .Flags }}
{{- range .Flags }}
	{{ goFieldName .Name }} {{ goTypeForFlag .Type }}
{{- end }}
{{- end }}
{{- if and (not .Args) (not .Flags) }}
	_ struct{}
{{- end }}
}
{{- end }}

type Handlers[T any] interface {
	Help(args []string) (T, error)
{{- range .Leafs }}
	Run{{ goNameForPath (cmdPath .) }}(params *{{ goNameForPath (cmdPath .) }}Params) (T, error)
{{- end }}
}

var CliGlobalFlags = []FlagDef{
{{- range .GlobalFlags }}
	{Name: {{ printf "%q" .Name }}, Short: {{ printf "%q" .Short }}, Type: {{ printf "%q" .Type }}, Desc: {{ printf "%q" .Desc }}},
{{- end }}
}

var CliTopics = []TopicDef{
{{- range .Topics }}
	{Name: {{ printf "%q" .Name }}, Desc: {{ printf "%q" .Desc }}, Text: {{ printf "%q" .Text }}},
{{- end }}
}

var CliCommands = []CommandDef{
{{- $root := . }}
{{- range .Commands }}
	{{ template "cmd" (dict "Cmd" . "Root" $root) }}
{{- end }}
}

{{- define "cmd" }}
{{- $c := .Cmd }}
{{- $root := .Root }}
CommandDef{
	Name: {{ printf "%q" $c.Name }},
	FullCommand: {{ printf "%q" (cmdPath $c) }},
	Desc: {{ printf "%q" $c.Desc }},
{{- range $p := $root.AttrDefs }}
	{{ goFieldName $p.Name }}: {{ attrLiteral $c $p.Name $p.Kind }},
{{- end }}
{{- if $c.Args }}
	Args: []ArgDef{
{{- range $c.Args }}
		{Name: {{ printf "%q" .Name }}, Type: {{ printf "%q" .Type }}, Desc: {{ printf "%q" .Desc }}},
{{- end }}
	},
{{- end }}
{{- if $c.Flags }}
	Flags: []FlagDef{
{{- range $c.Flags }}
		{Name: {{ printf "%q" .Name }}, Short: {{ printf "%q" .Short }}, Type: {{ printf "%q" .Type }}, Desc: {{ printf "%q" .Desc }}},
{{- end }}
	},
{{- end }}
{{- if $c.Examples }}
	Examples: []string{
{{- range $c.Examples }}
		{{ printf "%q" . }},
{{- end }}
	},
{{- end }}
{{- if $c.Subs }}
	Subs: []CommandDef{
{{- range $c.Subs }}
		{{ template "cmd" (dict "Cmd" . "Root" $root) }}
{{- end }}
	},
{{- end }}
},
{{- end }}

var CliAppName = {{ printf "%q" .AppName }}
var CliTagline = {{ printf "%q" .Tagline }}

type Invocation struct {
	Command *CommandDef
	Args    map[string]string
	Flags   map[string]any
}

func Parse[T any](h Handlers[T], args []string) (Action[T], *CommandDef, error) {
	if h == nil {
		return nil, nil, fmt.Errorf("handlers is nil")
	}
	var gf GlobalFlags
	remaining := ProcessGlobalFlags(args, &gf)

	if len(remaining) > 0 && remaining[0] == "help" {
		gf.Help = true
		remaining = remaining[1:]
	}

	if gf.Help || len(remaining) == 0 {
		return func() (T, error) {
			return h.Help(remaining)
		}, nil, nil
	}

	resolvedCmd, remArgs, err := Resolve(CliCommands, remaining)
	if err != nil {
		return nil, nil, err
	}

	inv := &Invocation{Command: resolvedCmd, Args: make(map[string]string), Flags: make(map[string]any)}
	if err := ParseParams(inv, resolvedCmd, remArgs); err != nil {
		return nil, resolvedCmd, err
	}

	switch resolvedCmd.FullCommand {
{{- range .Leafs }}
	case {{ printf "%q" (cmdPath .) }}:
		return handle{{ goNameForPath (cmdPath .) }}(h, inv, gf), resolvedCmd, nil
{{- end }}
	default:
		return nil, resolvedCmd, fmt.Errorf("no handler for command: %s", resolvedCmd.FullCommand)
	}
}

func ApplyGlobalFlag(g *GlobalFlags, name string, val any) {
	switch name {
{{- range .GlobalFlags }}
	case {{ printf "%q" .Name }}:
{{- if eq .Type "bool" }}
		if b, ok := val.(bool); ok {
			g.{{ goFieldName .Name }} = b
		}
{{- else if eq .Type "string" }}
		if s, ok := val.(string); ok {
			g.{{ goFieldName .Name }} = s
		}
{{- end }}
{{- end }}
	}
}

{{- range .Leafs }}
func handle{{ goNameForPath (cmdPath .) }}[T any](h Handlers[T], inv *Invocation, gf GlobalFlags) Action[T] {
	params := &{{ goNameForPath (cmdPath .) }}Params{}
	params.GlobalFlags = gf
{{- range .Args }}
	params.{{ goFieldName .Name }} = inv.Args[{{ printf "%q" .Name }}]
{{- end }}
{{- range .Flags }}
{{- if eq .Type "bool" }}
	params.{{ goFieldName .Name }} = BoolFlag(inv.Flags, {{ printf "%q" .Name }})
{{- else if eq .Type "string" }}
	params.{{ goFieldName .Name }} = StringFlag(inv.Flags, {{ printf "%q" .Name }})
{{- end }}
{{- end }}
	return func() (T, error) {
		return h.Run{{ goNameForPath (cmdPath .) }}(params)
	}
}
{{- end }}
