// Code generated by cligen; DO NOT EDIT.

package {{.Pkg}}

import (
	"fmt"
	"os"
	"strings"
)

type flagDef struct {
	Name  string
	Short string
	Type  string
	Desc  string
}

type argDef struct {
	Name string
	Type string
	Desc string
}

type commandDef struct {
	Name string
	Desc string
{{- range .ParamDefs }}
	{{ goFieldName .Name }} {{ goTypeForParam .Kind }}
{{- end }}
	Args     []*argDef
	Flags    []*flagDef
	Subs     []*commandDef
	Parent   *commandDef
	Examples []string
}

type topicDef struct {
	Name string
	Desc string
	Text string
}

type globalFlags struct {
{{- range .GlobalFlags }}
	{{ goFieldName .Name }} {{ goTypeForFlag .Type }}
{{- end }}
{{- if eq (len .GlobalFlags) 0 }}
	_ struct{}
{{- end }}
}

{{- range .Leafs }}
{{- $base := lowerFirst (goNameForPath (cmdPath .)) }}

type {{ $base }}Params struct {
	globalFlags
{{- if .Args }}
{{- range .Args }}
	{{ goFieldName .Name }} {{ goTypeForArg .Type }}
{{- end }}
{{- end }}
{{- if .Flags }}
{{- range .Flags }}
	{{ goFieldName .Name }} {{ goTypeForFlag .Type }}
{{- end }}
{{- end }}
{{- if and (not .Args) (not .Flags) }}
	_ struct{}
{{- end }}
}
{{- end }}

type Handlers interface {
{{- range .Leafs }}
	{{ goNameForPath (cmdPath .) }}(params *{{ lowerFirst (goNameForPath (cmdPath .)) }}Params) Action
{{- end }}
}

var cliGlobalFlags = []*flagDef{
{{- range .GlobalFlags }}
	{Name: {{ printf "%q" .Name }}, Short: {{ printf "%q" .Short }}, Type: {{ printf "%q" .Type }}, Desc: {{ printf "%q" .Desc }}},
{{- end }}
}

var cliTopics = []*topicDef{
{{- range .Topics }}
	{Name: {{ printf "%q" .Name }}, Desc: {{ printf "%q" .Desc }}, Text: {{ printf "%q" .Text }}},
{{- end }}
}

var cliCommands = buildCommands()
var cliAppName = {{ printf "%q" .AppName }}
var cliTagline = {{ printf "%q" .Tagline }}

func buildCommands() []*commandDef {
{{- range .AllCommands }}
{{- $c := . }}
	{{ cmdVar . }} := &commandDef{Name: {{ printf "%q" .Name }}, Desc: {{ printf "%q" .Desc }}{{- if .Parent }}, Parent: {{ cmdVar .Parent }}{{- end }}{{- range $p := $.ParamDefs }}, {{ goFieldName $p.Name }}: {{ paramLiteral $c $p.Name $p.Kind }}{{- end }}{{- if .Args }}, Args: []*argDef{ {{- range .Args }}{Name: {{ printf "%q" .Name }}, Type: {{ printf "%q" .Type }}, Desc: {{ printf "%q" .Desc }}},{{- end }} }{{- end }}{{- if .Flags }}, Flags: []*flagDef{ {{- range .Flags }}{Name: {{ printf "%q" .Name }}, Short: {{ printf "%q" .Short }}, Type: {{ printf "%q" .Type }}, Desc: {{ printf "%q" .Desc }}},{{- end }} }{{- end }}{{- if .Examples }}, Examples: []string{ {{- range .Examples }}{{ printf "%q" . }},{{- end }} }{{- end }} }
{{- end }}
{{- range .AllCommands }}
{{- if .Subs }}
	{{ cmdVar . }}.Subs = []*commandDef{ {{- range .Subs }}{{ cmdVar . }},{{- end }} }
{{- end }}
{{- end }}

	return []*commandDef{ {{- range .Commands }}{{ cmdVar . }},{{- end }} }
}

type invocation struct {
	Command *commandDef
	Args    map[string]string
	Flags   map[string]any
}

func Parse(h Handlers, args []string) (Action, error) {
	if h == nil {
		return nil, fmt.Errorf("handlers is nil")
	}
	var gf globalFlags
	var remaining []string
	help := false
	for i := 0; i < len(args); i++ {
		arg := args[i]
		if arg == "--help" || arg == "-h" {
			help = true
			continue
		}
		found := false
		for _, f := range cliGlobalFlags {
			if arg == "--"+f.Name || (f.Short != "" && arg == "-"+f.Short) {
				found = true
				if f.Type == "bool" {
					applyGlobalFlag(&gf, f.Name, true)
				} else if f.Type == "string" && i+1 < len(args) {
					applyGlobalFlag(&gf, f.Name, args[i+1])
					i++
				}
			}
		}
		if !found {
			remaining = append(remaining, arg)
		}
	}
	if help || len(remaining) == 0 {
		return helpAction(remaining), nil
	}
	if remaining[0] == "help" {
		return helpAction(remaining[1:]), nil
	}
	inv := &invocation{Args: make(map[string]string), Flags: make(map[string]any)}
	finalInv, err := resolve(inv, cliCommands, remaining)
	if err != nil {
		return nil, err
	}
	if finalInv == nil || finalInv.Command == nil {
		return nil, fmt.Errorf("no command resolved")
	}
	path := getCmdPath(finalInv.Command)
	switch path {
{{- range .Leafs }}
	case {{ printf "%q" (cmdPath .) }}:
		params := &{{ lowerFirst (goNameForPath (cmdPath .)) }}Params{}
{{- range .Args }}
		params.{{ goFieldName .Name }} = finalInv.Args[{{ printf "%q" .Name }}]
{{- end }}
		params.globalFlags = gf
{{- range .Flags }}
{{- if eq .Type "bool" }}
		params.{{ goFieldName .Name }} = boolFlag(finalInv.Flags, {{ printf "%q" .Name }})
{{- else if eq .Type "string" }}
		params.{{ goFieldName .Name }} = stringFlag(finalInv.Flags, {{ printf "%q" .Name }})
{{- end }}
{{- end }}
		action := h.{{ goNameForPath (cmdPath .) }}(params)
		if action == nil {
			return nil, fmt.Errorf("no handler for command: %s", path)
		}
		return action, nil
{{- end }}
	case "help":
		return helpAction(nil), nil
	default:
		return nil, fmt.Errorf("no handler for command: %s", path)
	}
}

func helpAction(args []string) Action {
	return func() (*ExecutionResult, error) {
		printHelp(args...)
		return &ExecutionResult{ExitCode: 0}, nil
	}
}

func applyGlobalFlag(g *globalFlags, name string, val any) {
	switch name {
{{- range .GlobalFlags }}
	case {{ printf "%q" .Name }}:
{{- if eq .Type "bool" }}
		if b, ok := val.(bool); ok {
			g.{{ goFieldName .Name }} = b
		}
{{- else if eq .Type "string" }}
		if s, ok := val.(string); ok {
			g.{{ goFieldName .Name }} = s
		}
{{- end }}
{{- end }}
	}
}
