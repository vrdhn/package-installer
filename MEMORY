# pi (package-installer) - Rust
deps: clap, log, env_logger, starlark(0.13.0), anyhow, allocative, serde, serde_json, parking_lot, regex, ureq, sha2, hex, dirs-next, serde_json_path, comfy-table, uuid, walkdir, glob

src/
 models/
  config: Config { cache_dir, config_dir, state_dir, meta_dir, download_dir }
  repository: Repository { uuid, path, name }, RepositoryConfig { repositories }
  package_entry: PackageEntry { name, function_name, filename }, InstallerEntry { name, function_name, filename }
  version_entry: VersionEntry { pkgname, version, release_date, release_type, url, filename, checksum, checksum_url, installer_command: Auto|Custom(String) }
  context: Context { os, arch, filename, download_dir, packages: RwLock, installers: RwLock, versions: RwLock }
  selector: PackageSelector { recipe, prefix, package, version }
 starlark/
  api: register_api (get_os, get_arch, add_package(name, fn), add_installer(name, fn), download, json_parse, json_dump, add_version(..., installer_command))
  runtime:
   - evaluate_file -> (Vec<PackageEntry>, Vec<InstallerEntry>)
   - execute_function -> Vec<VersionEntry>
   - execute_installer_function -> Vec<VersionEntry>
 services/
  downloader: ureq-based GET requests
  cache: SHA256-hashed filenames (URL-based), TTL-based validation
 cli/parser: Cli { verbose }, Repo { Add, Sync, List }, Package { Sync, List }, Disk { Info, Clean, Uninstall }, Devel { Test { filename, pkg } }
 logging/init: init_logging(verbose)
 commands/repo:
  - add: register repo path, generate UUID, store in repositories.json, trigger sync
  - sync: walk repo for .star files, evaluate, cache packages-<uuid>.json (includes installers), trigger list
  - list: display table of repo, type, name, and discovery function
 commands/package:
  - sync: [recipe]/[prefix]:package -> match & discover (handles installers), cache version-<uuid>-<sanitized_name>.json (sanitized with #)
  - list: [recipe]/[prefix]:package[=version] -> list latest 5 (glob/symbolic support), sanitized with #
  - selector: handles glob (v1.*) and symbolic (latest, stable, lts) versions
 commands/disk:
  - info: show disk usage of config, cache, and state directories
  - clean: delete the cache directory
  - uninstall: delete config, cache, and state directories (requires --confirm)
 commands/devel/test:
  1. evaluate_file -> collect PackageEntry & InstallerEntry list
  2. if pkg: match name -> execute_function -> collect VersionEntry list
  3. sort versions (date, version) -> print table (comfy-table)

logic:
- json_parse: trick using eval_statements("json") to get built-in module then calling .decode()
- json_dump: converts Starlark -> Serde, applies JSONPath (serde_json_path), prints pretty JSON
- add_version: stores metadata including checksum_url and optional installer_command; type logic (stable/lts/obsolete) handled in .star
- sorting: VersionEntry sorted by release_date then version string before display
- Sanitization: Package names in version cache filenames have '/' replaced with '#' to avoid directory issues.
