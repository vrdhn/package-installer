# pi (package-installer) - Rust
deps: clap, log, env_logger, starlark(0.13.0), anyhow, allocative, serde, serde_json, parking_lot, ureq(3.x), sha2, sha1, hex, dirs-next, serde_json_path, comfy-table, walkdir, rayon, dashmap, toml, tar, flate2, xz2, zip, whoami

src/
 models/
  config: Config { cache_dir, config_dir, state_dir, meta_dir, download_dir, packages_dir, pilocals_dir, state: Arc<State> }, State { repositories, package_lists, version_lists, meta_dir, download_dir, packages_dir, pilocals_dir }, is_inside_cave()
  repository: Repository { path, name }, Repositories { repositories, get_all(config), load, save }
  package_entry: PackageEntry { name, fn, file }, ManagerEntry { name, fn, file }, PackageList { packages, managers, get_for_repo(config, repo) }
  version_entry: VersionEntry { pkgname, version, release_date, release_type, url, filename, checksum, checksum_url, filemap, env, manager_command }
  selector: PackageSelector { recipe, prefix, package, version }
  context: Context { os, arch, filename, meta_dir, download_dir, packages_dir, state }, display_name()
  cave: Cave { name, workspace, homedir, settings, variants }, CaveSettings { packages, set, unset }
 starlark/
  api: register_api (get_os, get_arch, add_package, add_manager, download, json_parse, toml_parse, json_dump, add_version(..., filemap, env, manager_command))
  runtime: evaluate_file, execute_function, execute_manager_function (all use Arc<State>)
 services/
  downloader: download (String), download_to_file (Path, checksum check, progress). Supports SHA-1, SHA-256, SHA-512.
  unarchiver: unarchive (tar.gz, tar.xz, zip) to destination directory. Creates `.unarchived` marker file.
  sandbox: Bubblewrap wrapper for `bwrap` (binds, envs, unsets, command execution).
  cache: SHA256-hashed filenames (URL-based), TTL-based validation
  sync: core logic for syncing repo/package/manager data
 cli/parser: Cli { quiet, verbose, debug }, Repo, Package, Cave { Init, Info, Add { args }, Rem { args }, Resolve, Build, Run }, Disk, Devel { Test { filename, pkg } }
 commands/cave:
  - build: Resolves cave packages, downloads, unarchives, and applies filemap (symlinks) to `.pilocal` cache. If `manager_command` is present, it runs them inside a temporary writable sandbox.
  - run: Executes command inside a bubblewrap sandbox. Automatically runs build first. Maps cave homedir to host `$HOME`, cave workspace to same path, and binds system paths RO. Mounts `.pilocal` cache to `~/.pilocal` (usually RO, but RW during build manager execution). Sets PI_CAVE and prepends `~/.pilocal/bin` to PATH. Applies package and cave env vars.
  - info: Displays cave info.
 commands/devel:
  - test: Evaluates .star, calls discovery function, then performs test download and unarchive.

logic:
- Logging: Four levels: quiet (Error), default (Info), verbose (Debug), debug (Trace). Log messages use structured `[context]` prefixes and are concise.
- Managed Packages: `npm` and `cargo` packages skip download/unarchive and instead run installation commands inside the sandbox during build.
- .pilocal: Central storage for package binaries and files. Binaries should land in `~/.pilocal/bin`.
- Home Directory: Stored in `pi.cave.json` during `cave init`.
- Filemap (Symlinks): Applied from package directory to `.pilocal` cache. Supports `*` globs. Logs show relative paths.
- Sandbox (Run): Prepend `~/.pilocal/bin` to `PATH`. `CACHE_DIR` and `.pilocal` are writable during manager command execution.
- Resolve Query: Returns `(full_name, version, repo_name)`.
- Cave Mode (Read-Only): If `PI_CAVE` is detected, `pi` enters read-only mode for safety.
- Sanitization: Package name and version are sanitized for filesystem safety.
- Rust Component Handling: Correctly maps `rust-src`, `rust-std`, etc. to internal subfolders. Fixes manifest bugs by stripping `-preview` from disk paths.
